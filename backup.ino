#include <WiFi.h>
#include <time.h>
#include <TFT_eSPI.h>
#include <Wire.h>
#include <Adafruit_PN532.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>

// WiFi credentials - CHANGE THESE TO YOUR NETWORK
const char* ssid = "TP-Link_7DDE";
const char* password = "18152784";

// NTP server settings for Portugal
const char* ntpServer = "pt.pool.ntp.org";
const long gmtOffset_sec = 0;      // Portugal is GMT+0 in winter
const int daylightOffset_sec = 3600; // +1 hour for daylight saving

// PN532 I2C setup
#define PN532_SDA 25
#define PN532_SCL 26
Adafruit_PN532 nfc(PN532_SDA, PN532_SCL);

// API endpoint
const char* apiEndpoint = "http://192.168.1.68:3000/clock";

// Buzzer setup
int buzzerPin = 5; // GPIO 5 for buzzer

// TFT Display setup
TFT_eSPI tft = TFT_eSPI();

// Global variables
bool wifiConnected = false;
String currentTime = "00:00";
String previousTime = "";
bool wifiStatusChanged = false;
unsigned long lastTimeUpdate = 0;
const unsigned long timeUpdateInterval = 1000;

// Animation variables
unsigned long lastFrameTime = 0;
int frameIndex = 0;
const int frameCount = 3;
const unsigned long frameDuration = 650;
bool animationDirection = true; // true = forward, false = backward

// NFC and welcome screen variables
bool showWelcomeScreen = false;
String welcomeUsername = "";
String welcomeType = "";  // Added for storing type (in/out)
unsigned long welcomeStartTime = 0;
const unsigned long welcomeDisplayDuration = 5000; // 5 seconds
bool nfcInitialized = false;

static const unsigned char PROGMEM image_wifi_not_connected_bits[] = {
  0x0c,0x03,0xff,0x00,0x00,0x0c,0x03,0xff,0x00,0x00,0x03,0x3c,0x00,0xf0,0x00,
  0x03,0x3c,0x00,0xf0,0x00,0x00,0xc0,0x00,0x0f,0x00,0x00,0xc0,0x00,0x0f,0x00,
  0x0c,0x33,0xff,0x00,0xc0,0x0c,0x33,0xff,0x00,0xc0,0x30,0x0c,0x00,0xf0,0x30,
  0x30,0x0c,0x00,0xf0,0x30,0xc0,0xc3,0x00,0x0c,0x0c,0xc0,0xc3,0x00,0x0c,0x0c,
  0x03,0x00,0xcc,0x03,0x00,0x03,0x00,0xcc,0x03,0x00,0x0c,0x0f,0x33,0xc0,0xc0,
  0x0c,0x0f,0x33,0xc0,0xc0,0x00,0x30,0x0c,0x30,0x00,0x00,0x30,0x0c,0x30,0x00,
  0x00,0xc0,0x33,0x0c,0x00,0x00,0xc0,0x33,0x0c,0x00,0x00,0x03,0xcc,0xc0,0x00,
  0x00,0x03,0xcc,0xc0,0x00,0x00,0x0c,0x00,0x30,0x00,0x00,0x0c,0x00,0x30,0x00,
  0x00,0x00,0x30,0x0c,0x00,0x00,0x00,0x30,0x0c,0x00,0x00,0x00,0xcc,0x03,0x00,
  0x00,0x00,0xcc,0x03,0x00,0x00,0x00,0x30,0x00,0xc0,0x00,0x00,0x30,0x00,0xc0,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

// WiFi connected bitmap (38x32) - Simple WiFi icon
static const unsigned char PROGMEM image_wifi_connected_bits[] = {
  0x00,0x03,0xff,0x00,0x00,0x00,0x03,0xff,0x00,0x00,0x00,0x3f,0xff,0xf0,0x00,0x00,0x3f,0xff,0xf0,0x00,0x03,0xfc,0x00,0xff,0x00,0x03,0xfc,0x00,0xff,0x00,0x0f,0xc3,0xff,0x0f,0xc0,0x0f,0xc3,0xff,0x0f,0xc0,0x3f,0x3f,0xff,0xf3,0xf0,0x3f,0x3f,0xff,0xf3,0xf0,0xfc,0xff,0x03,0xfc,0xfc,0xfc,0xff,0x03,0xfc,0xfc,0x33,0xf0,0xfc,0x3f,0x30,0x33,0xf0,0xfc,0x3f,0x30,0x0f,0xcf,0xff,0xcf,0xc0,0x0f,0xcf,0xff,0xcf,0xc0,0x03,0x3f,0x03,0xf3,0x00,0x03,0x3f,0x03,0xf3,0x00,0x00,0xfc,0xfc,0xfc,0x00,0x00,0xfc,0xfc,0xfc,0x00,0x00,0x33,0xff,0x30,0x00,0x00,0x33,0xff,0x30,0x00,0x00,0x0f,0xcf,0xc0,0x00,0x00,0x0f,0xcf,0xc0,0x00,0x00,0x03,0x33,0x00,0x00,0x00,0x03,0x33,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0xfc,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};


static const uint8_t PROGMEM connect_button_frame2[] = { 
  0x00, 0x07, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x0f, 0xe0, 0x00, 0x00, 0x1f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf0, 
	0x00, 0x00, 0x3f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x7f, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 
	0xfc, 0x00, 0x01, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfe, 0x00, 0x01, 0xff, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0xff, 0x00, 0x07, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x80, 0x07, 0xfc, 
	0x00, 0x78, 0x00, 0x00, 0x00, 0x3c, 0x00, 0xff, 0x80, 0x0f, 0xf8, 0x01, 0xfc, 0x00, 0x00, 0x00, 
	0xfe, 0x00, 0x7f, 0xc0, 0x0f, 0xf0, 0x01, 0xfc, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x3f, 0xe0, 0x1f, 
	0xf0, 0x03, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x3f, 0xe0, 0x1f, 0xe0, 0x07, 0xfc, 0x00, 0x00, 
	0x00, 0xff, 0x80, 0x1f, 0xf0, 0x3f, 0xe0, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x80, 0x1f, 0xf0, 
	0x3f, 0xc0, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x0f, 0xf0, 0x3f, 0xc0, 0x0f, 0xf8, 0x00, 
	0x00, 0x00, 0x7f, 0xc0, 0x0f, 0xf8, 0x7f, 0x80, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x07, 
	0xf8, 0x7f, 0x80, 0x1f, 0xe0, 0x00, 0x70, 0x00, 0x1f, 0xe0, 0x07, 0xf8, 0x7f, 0x80, 0x3f, 0xe0, 
	0x01, 0xfe, 0x00, 0x1f, 0xf0, 0x07, 0xfc, 0xff, 0x00, 0x3f, 0xc0, 0x07, 0xff, 0x80, 0x0f, 0xf0, 
	0x03, 0xfc, 0xff, 0x00, 0x3f, 0xc0, 0x0f, 0xff, 0xc0, 0x0f, 0xf0, 0x03, 0xfc, 0xff, 0x00, 0x3f, 
	0x80, 0x0f, 0xff, 0xe0, 0x0f, 0xf0, 0x03, 0xfc, 0xff, 0x00, 0x7f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 
	0xf8, 0x03, 0xfc, 0xff, 0x00, 0x7f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 0xf8, 0x03, 0xfc, 0xfe, 0x00, 
	0x7f, 0x80, 0x1f, 0xff, 0xf0, 0x07, 0xf8, 0x01, 0xfc, 0xfe, 0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 
	0x07, 0xf8, 0x01, 0xfc, 0xfe, 0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 0x07, 0xf8, 0x01, 0xfc, 0xfe, 
	0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 0x07, 0xf8, 0x01, 0xfc, 0xff, 0x00, 0x7f, 0x80, 0x1f, 0xff, 
	0xe0, 0x07, 0xf8, 0x01, 0xfc, 0xff, 0x00, 0x3f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 0xf0, 0x03, 0xfc, 
	0xff, 0x00, 0x3f, 0xc0, 0x1f, 0xff, 0xc0, 0x0f, 0xf0, 0x03, 0xfc, 0xff, 0x00, 0x3f, 0xc0, 0x0f, 
	0xff, 0xc0, 0x0f, 0xf0, 0x03, 0xfc, 0xff, 0x00, 0x3f, 0xe0, 0x07, 0xff, 0x80, 0x0f, 0xf0, 0x03, 
	0xfc, 0xff, 0x80, 0x1f, 0xe0, 0x03, 0xfe, 0x00, 0x1f, 0xe0, 0x03, 0xf8, 0x7f, 0x80, 0x1f, 0xf0, 
	0x00, 0x70, 0x00, 0x1f, 0xe0, 0x07, 0xf8, 0x7f, 0x80, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xe0, 
	0x07, 0xf8, 0x7f, 0x80, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x07, 0xf8, 0x3f, 0xc0, 0x0f, 
	0xfc, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x0f, 0xf0, 0x3f, 0xe0, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 
	0x80, 0x0f, 0xf0, 0x3f, 0xe0, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x1f, 0xf0, 0x1f, 0xf0, 
	0x03, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x1f, 0xe0, 0x1f, 0xf0, 0x01, 0xfc, 0x00, 0x00, 0x00, 
	0xfe, 0x00, 0x3f, 0xe0, 0x0f, 0xf8, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x7f, 0xc0, 0x0f, 
	0xf8, 0x00, 0x70, 0x00, 0x00, 0x00, 0x38, 0x00, 0x7f, 0x80, 0x07, 0xfc, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xff, 0x80, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0x00, 
	0x03, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0x00, 0x01, 0xff, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x03, 0xfe, 0x00, 0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 
	0x00, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xfc, 0x00, 0x00, 0x7f, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 
	0xf0, 0x00, 0x00, 0x1f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x0f, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00
 };
static const uint8_t PROGMEM connect_button_frame1[] = { 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x78, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 
	0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 0xfe, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x03, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x00, 
	0x00, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 
	0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x1f, 0xe0, 0x00, 0x70, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 
	0x01, 0xfe, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x07, 0xff, 0x80, 0x0f, 0xf0, 
	0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x0f, 0xff, 0xc0, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 
	0x80, 0x0f, 0xff, 0xe0, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 
	0xf8, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 
	0x7f, 0x80, 0x1f, 0xff, 0xf0, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 
	0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 0x07, 0xf8, 0x00, 0x00, 0x00, 
	0x00, 0x7f, 0x80, 0x3f, 0xff, 0xf0, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x80, 0x1f, 0xff, 
	0xe0, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x80, 0x1f, 0xff, 0xe0, 0x07, 0xf0, 0x00, 0x00, 
	0x00, 0x00, 0x3f, 0xc0, 0x1f, 0xff, 0xc0, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xc0, 0x0f, 
	0xff, 0xc0, 0x0f, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xe0, 0x07, 0xff, 0x80, 0x0f, 0xf0, 0x00, 
	0x00, 0x00, 0x00, 0x1f, 0xe0, 0x03, 0xfe, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 
	0x00, 0x70, 0x00, 0x1f, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xf0, 0x00, 0x00, 0x00, 0x3f, 0xe0, 
	0x00, 0x00, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x0f, 
	0xfc, 0x00, 0x00, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 
	0x80, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0xfc, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x00, 0x00, 
	0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
 };
static const uint8_t PROGMEM connect_button_frame0[] = { 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x0f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x1f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x3f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 
	0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
 };

const uint8_t* connectButtonFrames[frameCount] = {
  connect_button_frame0,
  connect_button_frame1,
  connect_button_frame2
};

// Buzzer sound functions
void playSuccessSound() {
  tone(buzzerPin, 1500, 150); // High beep
  delay(200);
  tone(buzzerPin, 2000, 150); // Higher beep
  delay(200);
  noTone(buzzerPin);
}

void playErrorSound() {
  tone(buzzerPin, 500, 200);  // Low beep
  delay(250);
  tone(buzzerPin, 400, 200);  // Lower beep
  delay(250);
  tone(buzzerPin, 300, 300);  // Lowest beep
  delay(350);
  noTone(buzzerPin);
}

void playWelcomeSound(String type) {
  if (type == "in") {
    // Clock in sound - ascending tones
    tone(buzzerPin, 800, 100);
    delay(120);
    tone(buzzerPin, 1000, 100);
    delay(120);
    tone(buzzerPin, 1200, 150);
    delay(200);
    noTone(buzzerPin);
  } else if (type == "out") {
    // Clock out sound - descending tones
    tone(buzzerPin, 1200, 100);
    delay(120);
    tone(buzzerPin, 1000, 100);
    delay(120);
    tone(buzzerPin, 800, 150);
    delay(200);
    noTone(buzzerPin);
  }
}

void setup() {
  Serial.begin(115200);
  
  // Initialize buzzer pin
  pinMode(buzzerPin, OUTPUT);
  digitalWrite(buzzerPin, LOW);
  
  // Initialize TFT display
  tft.init();
  tft.setRotation(1); // Landscape mode 480x320
  tft.fillScreen(TFT_WHITE);
  tft.setTextColor(TFT_BLACK);
  tft.setTextSize(2);
  tft.drawString("A Conectar ao WiFi...", 50, 150);
  
  // Connect WiFi
  WiFi.begin(ssid, password);
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 20) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  wifiConnected = (WiFi.status() == WL_CONNECTED);
  Serial.println(wifiConnected ? "\nWiFi conectado!" : "\nErro no Wifi!");
  if (wifiConnected) {
    Serial.print("IP: "); Serial.println(WiFi.localIP());
    configTime(gmtOffset_sec, daylightOffset_sec, ntpServer);
    // Play success sound for WiFi connection
    playSuccessSound();
  } else {
    // Play error sound for WiFi failure
    playErrorSound();
  }
  
  // Initialize PN532
  Wire.begin(PN532_SDA, PN532_SCL);
  nfc.begin();
  
  uint32_t versiondata = nfc.getFirmwareVersion();
  if (versiondata) {
    Serial.print("Found chip PN5"); Serial.println((versiondata>>24) & 0xFF, HEX); 
    Serial.print("Firmware ver. "); Serial.print((versiondata>>16) & 0xFF, DEC); 
    Serial.print('.'); Serial.println((versiondata>>8) & 0xFF, DEC);
    nfc.SAMConfig();
    nfcInitialized = true;
    Serial.println("PN532 initialized successfully");
  } else {
    Serial.println("Didn't find PN53x board");
    nfcInitialized = false;
    // Play error sound for NFC failure
    playErrorSound();
  }
  
  draw();
}

void loop() {
  // Handle welcome screen timeout
  if (showWelcomeScreen && millis() - welcomeStartTime >= welcomeDisplayDuration) {
    showWelcomeScreen = false;
    welcomeUsername = "";
    welcomeType = "";  // Clear the type as well
    draw(); // Redraw main screen
  }
  
  // Only check for NFC if not showing welcome screen and NFC is initialized
  if (!showWelcomeScreen && nfcInitialized) {
    checkForNFC();
  }
  
  // Update time every second
  if (millis() - lastTimeUpdate >= timeUpdateInterval) {
    updateTime();
    lastTimeUpdate = millis();
    
    // Only update the time display area, not the whole screen
    if (!showWelcomeScreen && currentTime != previousTime) {
      updateTimeDisplay();
      previousTime = currentTime;
    }
  }
  
  // Check WiFi status
  bool currentWifiStatus = (WiFi.status() == WL_CONNECTED);
  if (currentWifiStatus != wifiConnected) {
    wifiConnected = currentWifiStatus;
    wifiStatusChanged = true;
    
    // Play sound based on WiFi status change
    if (wifiConnected) {
      playSuccessSound(); // WiFi reconnected
    } else {
      playErrorSound(); // WiFi disconnected
    }
    
    // Update only the WiFi icon area
    if (!showWelcomeScreen) {
      updateWiFiDisplay();
    }
  }
  
  // Update animation frame with bounce effect
  if (!showWelcomeScreen && millis() - lastFrameTime >= frameDuration) {
    updateAnimationFrame();
    lastFrameTime = millis();
    drawConnectButtonFrame(frameIndex);
  }
  
  // Only redraw entire screen if showing welcome screen and status changed
  if (!showWelcomeScreen && wifiStatusChanged) {
    wifiStatusChanged = false;
  }
  
  delay(50);
}

void updateAnimationFrame() {
  if (animationDirection) {
    // Moving forward
    frameIndex++;
    if (frameIndex >= frameCount - 1) {
      frameIndex = frameCount - 1;
      animationDirection = false; // Start going backward
    }
  } else {
    // Moving backward
    frameIndex--;
    if (frameIndex <= 0) {
      frameIndex = 0;
      animationDirection = true; // Start going forward
    }
  }
}

void updateTimeDisplay() {
  // Clear only the time area and redraw
  tft.fillRect(0, 0, 200, 51, 0xEF5D);  // Clear time area
  tft.setTextColor(TFT_BLACK);
  tft.setTextSize(4);
  tft.setTextDatum(TL_DATUM);
  tft.drawString(currentTime, 14, 9);
}

void updateWiFiDisplay() {
  // Clear only the WiFi icon area and redraw
  tft.fillRect(436, 8, 38, 32, 0xEF5D);  // Clear WiFi area
  if (wifiConnected) {
    tft.drawBitmap(436, 8, image_wifi_connected_bits, 38, 32, TFT_BLACK);
  } else {
    tft.drawBitmap(436, 8, image_wifi_not_connected_bits, 38, 32, TFT_BLACK);
  }
  
  // Update status text at bottom
  tft.fillRect(10, 280, 200, 10, 0xBDF7); // Clear status area
  tft.setTextSize(1);
  tft.setTextColor(TFT_BLACK);
  if (!wifiConnected) {
    tft.drawString("WiFi Disconnected", 10, 280);
  }
}

void checkForNFC() {
  uint8_t success;
  uint8_t uid[] = { 0, 0, 0, 0, 0, 0, 0 };  // Buffer to store the returned UID
  uint8_t uidLength;                        // Length of the UID (4 or 7 bytes depending on ISO14443A card type)
  
  success = nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLength, 100);
  
  if (success) {
    // Convert UID to hex string
    String cardUID = "";
    for (uint8_t i = 0; i < uidLength; i++) {
      if (uid[i] < 0x10) cardUID += "0";
      cardUID += String(uid[i], HEX);
    }
    cardUID.toUpperCase();
    
    Serial.println("NFC Card detected!");
    Serial.print("UID: "); Serial.println(cardUID);
    
    // Play card detection sound
    playSuccessSound();
    
    // Send API request
    sendUserRequest(cardUID);
    
    // Wait for card to be removed to prevent multiple reads
    while (nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLength, 100)) {
      delay(100);
    }
  }
}

void sendUserRequest(String cardUID) {
  if (!wifiConnected) {
    Serial.println("WiFi not connected, cannot send API request");
    playErrorSound(); // Play error sound for no WiFi
    showErrorMessage("WiFi desconectado");
    return;
  }
  
  HTTPClient http;
  http.begin(apiEndpoint);
  http.addHeader("Content-Type", "application/json");
  
  // Create JSON payload
  DynamicJsonDocument doc(1024);
  doc["uid"] = cardUID;
  String jsonString;
  serializeJson(doc, jsonString);
  
  Serial.print("Sending POST request to: "); Serial.println(apiEndpoint);
  Serial.print("Payload: "); Serial.println(jsonString);
  
  int httpResponseCode = http.POST(jsonString);
  
  if (httpResponseCode > 0) {
    String response = http.getString();
    Serial.print("HTTP Response: "); Serial.println(httpResponseCode);
    Serial.print("Response: "); Serial.println(response);
    
    // Parse JSON response
    DynamicJsonDocument responseDoc(1024);
    deserializeJson(responseDoc, response);
    
    if (responseDoc.containsKey("error")) {
      String error = responseDoc["error"];
      Serial.print("API Error: "); Serial.println(error);
      playErrorSound(); // Play error sound for API error
      showErrorMessage(error);
    } else if (responseDoc.containsKey("username") && responseDoc.containsKey("type")) {
      String username = responseDoc["username"];
      String type = responseDoc["type"];  // "in" or "out"
      Serial.print("User: "); Serial.print(username);
      Serial.print(" - Type: "); Serial.println(type);
      
      // Play welcome sound based on type
      playWelcomeSound(type);
      
      showWelcomeMessage(username, type);  // Pass both parameters
    } else {
      Serial.println("Unknown response format");
      playErrorSound(); // Play error sound for unknown response
      showErrorMessage("Resposta invalida");
    }
  } else {
    Serial.print("HTTP Error: "); Serial.println(httpResponseCode);
    playErrorSound(); // Play error sound for HTTP error
    showErrorMessage("Erro de ligacao");
  }
  
  http.end();
}

void showWelcomeMessage(String username, String type) {
  showWelcomeScreen = true;
  welcomeUsername = username;
  welcomeType = type;  // Store the type
  welcomeStartTime = millis();
  drawWelcomeScreen();
}

void showErrorMessage(String error) {
  // Show error temporarily
  tft.fillScreen(0xBDF7);
  tft.fillRect(0, 0, 480, 51, 0xEF5D);  // Top bar
  
  // Display time
  tft.setTextColor(TFT_BLACK);
  tft.setTextSize(4);
  tft.setTextDatum(TL_DATUM);
  tft.drawString(currentTime, 14, 9);
  
  // Display WiFi icon
  if (wifiConnected) {
    tft.drawBitmap(436, 8, image_wifi_connected_bits, 38, 32, TFT_BLACK);
  } else {
    tft.drawBitmap(436, 8, image_wifi_not_connected_bits, 38, 32, TFT_BLACK);
  }
  
  // Show error message
  tft.setTextSize(3);
  tft.setTextColor(TFT_RED);
  tft.setTextDatum(MC_DATUM);
  tft.drawString("ERRO:", 240, 130);
  tft.setTextSize(2);
  tft.drawString(error, 240, 170);
  
  delay(3000); // Show error for 3 seconds
  draw(); // Return to main screen
}

void drawWelcomeScreen() {
  tft.fillScreen(0xBDF7);             // Background
  tft.fillRect(0, 0, 480, 51, 0xEF5D);  // Top bar
  
  // Display time
  tft.setTextColor(TFT_BLACK);
  tft.setTextSize(4);
  tft.setTextDatum(TL_DATUM);
  tft.drawString(currentTime, 14, 9);
  
  // Display WiFi icon
  if (wifiConnected) {
    tft.drawBitmap(436, 8, image_wifi_connected_bits, 38, 32, TFT_BLACK);
  } else {
    tft.drawBitmap(436, 8, image_wifi_not_connected_bits, 38, 32, TFT_BLACK);
  }
  
  // Welcome message based on type
  tft.setTextSize(3);
  tft.setTextColor(TFT_BLACK);
  tft.setTextDatum(MC_DATUM);
  
  if (welcomeType == "in") {
    tft.drawString("Bem vindo/a,", 240, 140);
  } else if (welcomeType == "out") {
    tft.drawString("Tenha um bom dia,", 240, 140);
  } else {
    // Fallback message if type is unknown
    tft.drawString("Ola,", 240, 140);
  }
  
  // Display username
  tft.setTextSize(4);
  tft.setTextColor(0x07E0); // Green color
  tft.drawString(welcomeUsername, 240, 180);
}

void updateTime() {
  if (wifiConnected) {
    struct tm timeinfo;
    if (getLocalTime(&timeinfo)) {
      char timeString[6];
      strftime(timeString, sizeof(timeString), "%H:%M", &timeinfo);
      currentTime = String(timeString);
    }
  }
}

void draw() {
  tft.fillScreen(0xBDF7);             // Background
  tft.fillRect(0, 51, 480, 270, 0xCE79); // Middle section
  tft.fillRoundRect(177, 110, 125, 125, 20, 0xEF5D); // Button base
  tft.fillRect(0, 0, 480, 51, 0xEF5D);  // Top bar

  // Display time
  tft.setTextColor(TFT_BLACK);
  tft.setTextSize(4);
  tft.setTextDatum(TL_DATUM);
  tft.drawString(currentTime, 14, 9);

  // Display WiFi icon
  if (wifiConnected) {
    tft.drawBitmap(436, 8, image_wifi_connected_bits, 38, 32, TFT_BLACK);
  } else {
    tft.drawBitmap(436, 8, image_wifi_not_connected_bits, 38, 32, TFT_BLACK);
  }

  // Draw animated connect button
  drawConnectButtonFrame(frameIndex);

  // Optional WiFi status text
  tft.setTextSize(1);
  tft.setTextColor(TFT_BLACK);
  if (!wifiConnected) tft.drawString("WiFi Disconnected", 10, 280);
  
  // NFC status
  if (nfcInitialized) {
  } else {
    tft.drawString("Erro no MÃ³dulo NFC", 10, 290);
  }
}

void drawConnectButtonFrame(int idx) {
  // Clear button area
  tft.fillRoundRect(177, 110, 125, 125, 20, 0xEF5D);
  // Draw frame bitmap centered inside button
  tft.drawBitmap(196, 144, connectButtonFrames[idx], 86, 56, TFT_BLACK);
}